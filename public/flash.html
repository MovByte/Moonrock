<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="title" content="Moonrock">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Moonrock">
    <meta name="keywords" content="games, gaming, search engine">
    <meta name="author" content="g9aerospace & dave9123">
    <meta property="og:title" content="Home">
    <meta property="og:description" content="A gaming search engine">
    <meta property="og:image" content="https://github.com/VyperGroup/Moonrock/blob/dave9123/public_html/assets/images/vyper.png?raw=true">
    <meta property="og:url" content="https://moonrock.com">
    <meta property="theme-color" content="#2596be">   
    
    <link rel="stylesheet" href="assets/css/global.css">
    <link rel="stylesheet" href="assets/css/header.css">
    <link rel="stylesheet" href="assets/css/footer.css">

    <script src="assets/script.js"></script>

    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Red+Hat+Display:wght@400;500;700&display=swap">
    <title>Moonrock</title>
    <script src="https://unpkg.com/@ruffle-rs/ruffle"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js" integrity="sha512-XMVd28F1oH/O71fzwBnV7HucLxVwtxf26XV8P4wPk26EDxuGZ91N8bsOttmnomcCD3CS5ZMRL50H0GgOHvegtg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-image: url('assets/images/moon.jpg');
        }
        #player {
            display: flex;
            border: none;
            position: fixed;
            text-align: center;
            justify-content: center;
            align-items: center;
        }
        .footer {
            bottom: 0;
            width: 100%;
            text-align: center;
            padding: 10px;
        }
    </style>
</head>

<body>

    <!-- Header -->
    <header id="header-container">
    </header>

    <!--Main-->
    <div id="player" style="align-items: center;"></div>
    <div class="footer">
        <input type="button" value="Fullscreen" onclick="fullscreen()">
        <br>
        <p id="zipFlashpoint" style="display: none;">Zip mode instead of direct game mode? <select id="flashpointZip">
            <option value="true">Yes</option>
            <option value="false">No</option>
        </select></p>
    </div>
    <script>
        let player = window.RufflePlayer.newest().createPlayer();
        let gamePath = localStorage.getItem('gamePath');
        let provider = localStorage.getItem('provider');
        let zipPath = undefined;
        if (localStorage.getItem('provider') === "flashpoint") {
            zipPath = localStorage.getItem('zipPath');
            document.getElementById("zipFlashpoint").style.display = "block";
            document.getElementById("flashpointZip").value = localStorage.getItem("useFlashpointZip") || "false";
        }
        document.getElementById("flashpointZip").addEventListener("change", function() {
            localStorage.setItem("useFlashpointZip", document.getElementById("flashpointZip").value);
            location.reload();
        });
        player.config.base = gamePath.substring(0, gamePath.lastIndexOf('/') + 1);
        player.config.allowScriptAccess = true;
        document.querySelector("#player").append(player);
        if (provider === "flashpoint" && localStorage.getItem('useFlashpointZip') === "true") {
            (async () => {
                try {
                    if (zipPath === undefined) {
                        throw new Error('Zip path not found in localStorage.');
                        alert('An error occurred.');
                    }
                    const zip = await JSZip.loadAsync(await fetch(`proxy/?url=${zipPath}`).then(r => r.blob()));
                    console.log(Object.keys(zip.files));
                    const gameFileData = await zip.file(`content/${new URL(gamePath).hostname}${new URL(gamePath).pathname}`);
                    console.log(`Searching for: content/${new URL(gamePath).hostname}${new URL(gamePath).pathname}`);
                    if (gameFileData === null) {
                        throw new Error(`File not found in zip: ${zipPath}`);
                        alert('An error occurred.');
                    }
                    const gameBlobUrl = URL.createObjectURL(await gameFileData.async('blob'));
                    player.load(gameBlobUrl);
                } catch (error) {
                    console.error(error);
                    alert('An error occurred.');
                };
            })();
        //} else if (zipPath !== undefined) {
        //    player.load(gamePath);
        } else {
            player.load(gamePath);
        }
        player.addEventListener('loadedmetadata', () => {
            if (player.metadata.width > 1 && player.metadata.height > 1) {
                player.style.width  = player.metadata.width  + 'px';
                player.style.height = player.metadata.height + 'px';
            }
        });
        function fullscreen() {
            player.requestFullscreen();
        };
    </script>

    <!-- Footer -->
    <footer id="footer-container">
    </footer>
    <script src="assets/js/global.js"></script>
</body>
</html>